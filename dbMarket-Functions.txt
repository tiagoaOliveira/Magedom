-- ============================================
-- TABELA: MARKETPLACE (LOJA DE JOGADORES)
-- ============================================
CREATE TABLE public.marketplace_listings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  seller_id UUID NOT NULL REFERENCES public.users(id) ON DELETE CASCADE,
  item_type TEXT NOT NULL CHECK (item_type IN ('skill', 'xp_item')),
  item_id INT NOT NULL,
  quantidade INT NOT NULL CHECK (quantidade > 0),
  preco DECIMAL(10, 2) NOT NULL CHECK (preco > 0),
  status TEXT NOT NULL DEFAULT 'ativa' CHECK (status IN ('ativa', 'vendida', 'cancelada')),
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_marketplace_status ON public.marketplace_listings(status) WHERE status = 'ativa';
CREATE INDEX idx_marketplace_item ON public.marketplace_listings(item_type, item_id, status);
CREATE INDEX idx_marketplace_seller ON public.marketplace_listings(seller_id);

-- RLS para marketplace (OTIMIZADO)
ALTER TABLE public.marketplace_listings ENABLE ROW LEVEL SECURITY;

-- Todos podem ver anúncios ativos
CREATE POLICY "marketplace_select_active"
ON public.marketplace_listings
FOR SELECT
USING (status = 'ativa' OR seller_id = (SELECT auth.uid()));

-- Apenas o vendedor pode inserir
CREATE POLICY "marketplace_insert_own"
ON public.marketplace_listings
FOR INSERT
WITH CHECK (seller_id = (SELECT auth.uid()) AND status = 'ativa');

-- Apenas o vendedor pode atualizar seus próprios anúncios
CREATE POLICY "marketplace_update_own"
ON public.marketplace_listings
FOR UPDATE
USING (seller_id = (SELECT auth.uid()))
WITH CHECK (seller_id = (SELECT auth.uid()));

-- Apenas o vendedor pode deletar
CREATE POLICY "marketplace_delete_own"
ON public.marketplace_listings
FOR DELETE
USING (seller_id = (SELECT auth.uid()));

-- ============================================
-- FUNÇÃO: LISTAR ITEM NO MARKETPLACE
-- ============================================
CREATE OR REPLACE FUNCTION public.list_item_on_marketplace(
  p_user_id UUID,
  p_item_type TEXT,
  p_item_id INT,
  p_quantidade INT,
  p_preco DECIMAL
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_quantidade_disponivel INT;
  v_listing_id UUID;
BEGIN
  -- Validação de autorização
  IF p_user_id != auth.uid() THEN
    RAISE EXCEPTION 'Unauthorized';
  END IF;

  IF p_item_type NOT IN ('skill', 'xp_item') THEN
    RAISE EXCEPTION 'Tipo de item inválido';
  END IF;

  IF p_quantidade <= 0 OR p_preco <= 0 THEN
    RAISE EXCEPTION 'Quantidade e preço devem ser maiores que zero';
  END IF;

  -- Verificar disponibilidade no inventário
  IF p_item_type = 'skill' THEN
    SELECT quantidade INTO v_quantidade_disponivel
    FROM public.user_skills
    WHERE user_id = p_user_id AND skill_id = p_item_id;
  ELSE
    SELECT quantidade INTO v_quantidade_disponivel
    FROM public.user_xp_items
    WHERE user_id = p_user_id AND item_id = p_item_id;
  END IF;

  IF v_quantidade_disponivel IS NULL OR v_quantidade_disponivel < p_quantidade THEN
    RAISE EXCEPTION 'Quantidade insuficiente no inventário';
  END IF;

  -- Remover do inventário
  IF p_item_type = 'skill' THEN
    UPDATE public.user_skills
    SET quantidade = quantidade - p_quantidade,
        updated_at = NOW()
    WHERE user_id = p_user_id AND skill_id = p_item_id;
    
    -- Remover se quantidade chegou a zero
    DELETE FROM public.user_skills
    WHERE user_id = p_user_id AND skill_id = p_item_id AND quantidade = 0;
  ELSE
    UPDATE public.user_xp_items
    SET quantidade = quantidade - p_quantidade,
        updated_at = NOW()
    WHERE user_id = p_user_id AND item_id = p_item_id;
    
    -- Remover se quantidade chegou a zero
    DELETE FROM public.user_xp_items
    WHERE user_id = p_user_id AND item_id = p_item_id AND quantidade = 0;
  END IF;

  -- Criar listing no marketplace
  INSERT INTO public.marketplace_listings (seller_id, item_type, item_id, quantidade, preco)
  VALUES (p_user_id, p_item_type, p_item_id, p_quantidade, p_preco)
  RETURNING id INTO v_listing_id;

  RETURN jsonb_build_object(
    'success', true,
    'listing_id', v_listing_id,
    'item_type', p_item_type,
    'item_id', p_item_id,
    'quantidade', p_quantidade,
    'preco', p_preco
  );
END;
$$;

-- ============================================
-- FUNÇÃO: COMPRAR ITEM DO MARKETPLACE
-- ============================================
CREATE OR REPLACE FUNCTION public.buy_from_marketplace(
  p_buyer_id UUID,
  p_listing_id UUID
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_listing RECORD;
  v_buyer_saldo DECIMAL(10, 2);
  v_taxa DECIMAL(10, 2);
  v_valor_vendedor DECIMAL(10, 2);
BEGIN
  -- Validação de autorização
  IF p_buyer_id != auth.uid() THEN
    RAISE EXCEPTION 'Unauthorized';
  END IF;

  -- Buscar informações do listing
  SELECT * INTO v_listing
  FROM public.marketplace_listings
  WHERE id = p_listing_id AND status = 'ativa'
  FOR UPDATE;

  IF v_listing.id IS NULL THEN
    RAISE EXCEPTION 'Listing não encontrado ou já vendido';
  END IF;

  -- Não pode comprar do próprio anúncio
  IF v_listing.seller_id = p_buyer_id THEN
    RAISE EXCEPTION 'Você não pode comprar seu próprio anúncio';
  END IF;

  -- Verificar saldo do comprador
  SELECT saldo INTO v_buyer_saldo
  FROM public.users
  WHERE id = p_buyer_id
  FOR UPDATE;

  IF v_buyer_saldo < v_listing.preco THEN
    RAISE EXCEPTION 'Saldo insuficiente';
  END IF;

  -- Calcular taxa do marketplace (5%)
  v_taxa := v_listing.preco * 0.05;
  v_valor_vendedor := v_listing.preco - v_taxa;

  -- Atualizar saldo do comprador
  UPDATE public.users
  SET saldo = saldo - v_listing.preco
  WHERE id = p_buyer_id;

  -- Atualizar saldo do vendedor
  UPDATE public.users
  SET saldo = saldo + v_valor_vendedor
  WHERE id = v_listing.seller_id;

  -- Adicionar item ao inventário do comprador
  IF v_listing.item_type = 'skill' THEN
    INSERT INTO public.user_skills (user_id, skill_id, quantidade)
    VALUES (p_buyer_id, v_listing.item_id, v_listing.quantidade)
    ON CONFLICT (user_id, skill_id)
    DO UPDATE SET 
      quantidade = user_skills.quantidade + v_listing.quantidade,
      updated_at = NOW();
  ELSE
    INSERT INTO public.user_xp_items (user_id, item_id, quantidade)
    VALUES (p_buyer_id, v_listing.item_id, v_listing.quantidade)
    ON CONFLICT (user_id, item_id)
    DO UPDATE SET 
      quantidade = user_xp_items.quantidade + v_listing.quantidade,
      updated_at = NOW();
  END IF;

  -- Marcar listing como vendido
  UPDATE public.marketplace_listings
  SET status = 'vendida',
      updated_at = NOW()
  WHERE id = p_listing_id;

  -- Registrar transação do comprador
  INSERT INTO public.transactions (
    user_id, tipo, item_type, item_id, quantidade, valor,
    detalhes
  )
  VALUES (
    p_buyer_id, 'compra_marketplace', v_listing.item_type, 
    v_listing.item_id, v_listing.quantidade, v_listing.preco,
    jsonb_build_object(
      'listing_id', p_listing_id,
      'seller_id', v_listing.seller_id
    )
  );

  -- Registrar transação do vendedor
  INSERT INTO public.transactions (
    user_id, tipo, item_type, item_id, quantidade, valor,
    detalhes
  )
  VALUES (
    v_listing.seller_id, 'venda_marketplace', v_listing.item_type,
    v_listing.item_id, v_listing.quantidade, v_valor_vendedor,
    jsonb_build_object(
      'listing_id', p_listing_id,
      'buyer_id', p_buyer_id,
      'preco_total', v_listing.preco,
      'taxa_marketplace', v_taxa
    )
  );

  RETURN jsonb_build_object(
    'success', true,
    'item_type', v_listing.item_type,
    'item_id', v_listing.item_id,
    'quantidade', v_listing.quantidade,
    'preco_pago', v_listing.preco
  );
END;
$$;

-- ============================================
-- FUNÇÃO: CANCELAR LISTING NO MARKETPLACE
-- ============================================
CREATE OR REPLACE FUNCTION public.cancel_marketplace_listing(
  p_user_id UUID,
  p_listing_id UUID
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
DECLARE
  v_listing RECORD;
BEGIN
  -- Validação de autorização
  IF p_user_id != auth.uid() THEN
    RAISE EXCEPTION 'Unauthorized';
  END IF;

  -- Buscar listing
  SELECT * INTO v_listing
  FROM public.marketplace_listings
  WHERE id = p_listing_id AND seller_id = p_user_id AND status = 'ativa'
  FOR UPDATE;

  IF v_listing.id IS NULL THEN
    RAISE EXCEPTION 'Listing não encontrado ou já processado';
  END IF;

  -- Devolver item ao inventário
  IF v_listing.item_type = 'skill' THEN
    INSERT INTO public.user_skills (user_id, skill_id, quantidade)
    VALUES (p_user_id, v_listing.item_id, v_listing.quantidade)
    ON CONFLICT (user_id, skill_id)
    DO UPDATE SET 
      quantidade = user_skills.quantidade + v_listing.quantidade,
      updated_at = NOW();
  ELSE
    INSERT INTO public.user_xp_items (user_id, item_id, quantidade)
    VALUES (p_user_id, v_listing.item_id, v_listing.quantidade)
    ON CONFLICT (user_id, item_id)
    DO UPDATE SET 
      quantidade = user_xp_items.quantidade + v_listing.quantidade,
      updated_at = NOW();
  END IF;

  -- Marcar como cancelado
  UPDATE public.marketplace_listings
  SET status = 'cancelada',
      updated_at = NOW()
  WHERE id = p_listing_id;

  -- Registrar transação
  INSERT INTO public.transactions (
    user_id, tipo, item_type, item_id, quantidade,
    detalhes
  )
  VALUES (
    p_user_id, 'cancelamento_listing', v_listing.item_type,
    v_listing.item_id, v_listing.quantidade,
    jsonb_build_object('listing_id', p_listing_id)
  );

  RETURN jsonb_build_object(
    'success', true,
    'item_devolvido', true
  );
END;
$$;

